# Kintone Schema Listing

## 概要
Kintoneアプリケーションのスキーマとデータを検索・表示・エクスポートするためのシステムです。
データベース構造の詳細な確認、レコードデータの表示、CSVエクスポート機能を提供します。

## 主な機能
- **スキーマ表示**: フィールド構造の詳細表示（オプション詳細付き）
- **レコードデータ表示**: テーブル形式での見やすい表示
- **CSV出力**: スキーマ・レコードデータの完全エクスポート
- **テーブルリサイズ**: マウスドラッグでカラム幅調整
- **グループ・サブテーブル対応**: 複雑なフィールド構造に完全対応
- **高度なフィールド対応**: 計算フィールド、関連レコード一覧、ルックアップフィールドの詳細情報表示
- **アプリ名表示**: 関連レコード一覧・ルックアップフィールドでアプリ名も併せて表示
- **UIリセット機能**: アプリ一覧表示時の画面自動リセット
- **ルックアップフィールド完全対応**: フィールドタイプに関係なくlookupプロパティを持つフィールドをルックアップとして処理
- **統一されたUI**: フィールドコードカラムのフォントとサイズをフィールド名カラムに統一

## ファイル構成

### 必須ファイル（以下の順序で読み込む）
1. **kintoneApi.js** - Kintone API関連の機能
2. **groupFieldProcessor.js** - グループフィールド処理機能
3. **subtableFieldProcessor.js** - サブテーブルフィールド処理機能
4. **dataFormatters.js** - データフォーマット機能
5. **csvExport.js** - CSV出力機能
6. **uiHelpers.js** - UI関連のヘルパー機能
7. **queryTable-main.js** - メイン機能（統合）

### オプションファイル
- **subtableDisplay.js** - サブテーブル表示機能

## 各モジュールの機能

### 1. kintoneApi.js
- 現在のアプリ情報取得
- スペース内の全アプリ一覧取得
- アプリ名からアプリID取得
- アプリのスキーマ取得（グループフィールド詳細処理対応）
- レコードデータ取得
- アプリID からアプリ名取得（アプリ名表示機能用）
- **グループフィールド処理**: レイアウト情報からグループ内フィールドの詳細取得
- **フィールドキー生成**: `code`プロパティが存在しないフィールドの適切なキー生成

**公開関数:**
```javascript
window.KintoneAPI = {
  getCurrentAppInfo,
  getAllAppsInSpace,
  getAppIdByName,
  getAppSchema,
  getRecords,
  getAppNameById
}
```

### 2. groupFieldProcessor.js
- グループフィールドのスキーマ処理
- グループフィールドのレコードデータ処理
- CSV出力用のグループフィールド処理
- グループフィールドの存在チェック・カウント機能
- **LABELフィールド対応**: グループ内のラベルフィールドの適切な処理
- **ルックアップフィールド対応**: グループ内のルックアップフィールドの詳細情報表示

**公開関数:**
```javascript
window.GroupFieldProcessor = {
  processGroupSchema,
  processGroupRecordData,
  formatGroupFieldValue,
  processGroupSchemaForCSV,
  getGroupHeadersForCSV,
  getGroupValueForCSV,
  hasGroupFields,
  countGroupFields
}
```

### 3. subtableFieldProcessor.js
- サブテーブルフィールドのスキーマ処理
- サブテーブルデータの整理とフォーマット
- CSV出力用のサブテーブル処理
- サブテーブルフィールドの存在チェック・カウント機能
- **LABELフィールド対応**: サブテーブル内のラベルフィールドの適切な処理
- **ルックアップフィールド対応**: サブテーブル内のルックアップフィールドの詳細情報表示

**公開関数:**
```javascript
window.SubtableFieldProcessor = {
  processSubtableSchema,
  formatSubtableData,
  processSubtableRecordData,
  processSubtableSchemaForCSV,
  processSubtableRecordsForCSV,
  hasSubtableFields,
  countSubtableFields,
  countSubtableRows
}
```

### 4. dataFormatters.js
- フィールドタイプの日本語変換
- スキーマの表示用フォーマット
- レコードデータの整理
- **LOOKUPフィールド対応**: ルックアップフィールドの適切な値抽出

**公開関数:**
```javascript
window.DataFormatters = {
  getFieldTypeLabel,
  formatSchema,
  formatRecordData
}
```

### 5. csvExport.js
- スキーマのCSV変換・ダウンロード
- レコードデータのCSV変換・ダウンロード
- CSVエクスポートボタンの追加
- **LABEL・LOOKUPフィールド対応**: ラベル・ルックアップフィールドの適切なCSV出力
- **ルックアップフィールド完全対応**: フィールドタイプに関係なくlookupプロパティを持つフィールドを処理

**公開関数:**
```javascript
window.CSVExport = {
  downloadCSV,
  schemaToCSV,
  recordsToCSV,
  addSchemaExportButton,
  addRecordExportButton
}
```

### 6. uiHelpers.js
- メッセージ表示機能
- アプリ一覧表示UI
- スキーマテーブル表示（オプション詳細カラム付き）
- レコードテーブル表示
- テーブルカラムリサイズ機能（マウスドラッグ対応）
- フィールドオプション詳細生成（選択肢、グループ・サブテーブルフィールド数表示）
- アプリ名表示・キャッシュ機能（関連レコード一覧・ルックアップフィールド用）
- **画面リセット機能**: アプリ一覧表示時の画面クリア機能
- **ルックアップフィールド完全対応**: フィールドタイプに関係なくlookupプロパティを持つフィールドを処理
- **統一されたUI**: フィールドコードカラムのフォントとサイズをフィールド名カラムに統一

**公開関数:**
```javascript
window.UIHelpers = {
  showMessage,
  displayAppList,
  displaySchemaTable,
  displayRecordTable,
  makeTableResizable,
  updateAppNameCache,
  getAppDisplayName,
  resetDisplay
}
```

### 7. queryTable-main.js
- メイン統合機能
- 検索UI作成
- 依存関係チェック
- 検索実行
- **UIリセット統合**: アプリ一覧表示ボタンでの画面リセット機能

**公開関数:**
```javascript
window.QueryTable = {
  executeQuery,
  createQueryUI,
  checkDependencies
}
```

### 8. subtableDisplay.js（オプション）
- サブテーブルデータの専用表示機能
- 各サブテーブルを独立したテーブルとして表示
- 親レコードとの関連表示
- サブテーブルテーブルのカラムリサイズ機能

**公開関数:**
```javascript
window.displaySubtables = (records, schema, containerElement)
window.initSubtableDisplay = () => {}
```

## 詳細機能

### テーブル表示機能
- **カラムリサイズ**: 全テーブル（スキーマ、レコード、サブテーブル）でマウスドラッグによるカラム幅調整
- **統一されたUI**: フィールドコードカラムのフォントとサイズをフィールド名カラムに統一
- **オプション詳細表示**: CSVと同等の詳細情報をブラウザ上で確認
  - 選択肢型フィールド: 「選択肢キー:表示名」形式
  - 計算フィールド: 「計算式: [式]」形式
  - 関連レコード一覧フィールド: 関連アプリ、条件、絞り込み、表示フィールド、ソート情報
  - ルックアップフィールド: 参照アプリ、参照キー、フィールドマッピング、検索対象、絞り込み、ソート情報
  - グループフィールド: 「グループ内フィールド数: X」
  - サブテーブルフィールド: 「サブフィールド数: X」
  - その他フィールド: 「設定名=値」形式

### スキーマ表示の詳細
- **メインフィールド**: フィールドコード、名前、タイプ、必須、説明、オプション詳細
- **サブフィールド**: グループ内・サブテーブル内フィールドを階層表示
- **視覚的区別**: サブフィールドは背景色とインデントで区別

### CSV出力の詳細
- **スキーマCSV**: 全フィールド情報（グループ・サブテーブル展開済み）
- **レコードCSV**: 基本レコードデータ
- **サブテーブル含むCSV**: サブテーブルデータも別セクションとして出力
- **文字エンコーディング**: UTF-8 BOM付き（Excel対応）
- **高度なフィールド対応**:
  - **計算フィールド**: 計算式をオプション詳細に表示
  - **関連レコード一覧**: 関連アプリ、条件、表示フィールドなどの設定情報を表示
  - **ルックアップフィールド**: 参照アプリ、フィールドマッピング、検索条件などの詳細を表示
- **Excel表示注意**: 計算式にカンマ（,）が含まれる場合、Excelで正しく表示されない場合があります
  - この場合は、Excelの「テキストファイルウィザード」を使用して手動でCSVを開くことを推奨します

## 使用方法

### 1. ファイルの読み込み
Kintoneアプリの「JavaScript/CSSでカスタマイズ」で以下の順序でファイルを読み込んでください：

```html
<!-- 必須ファイル（順序重要） -->
<script src="kintoneApi.js"></script>
<script src="groupFieldProcessor.js"></script>
<script src="subtableFieldProcessor.js"></script>
<script src="dataFormatters.js"></script>
<script src="csvExport.js"></script>
<script src="uiHelpers.js"></script>
<script src="queryTable-main.js"></script>

<!-- オプション -->
<script src="subtableDisplay.js"></script>
```

### 2. 基本的な使用方法
1. Kintoneアプリの一覧画面で「データ検索UI表示」ボタンをクリック
2. アプリケーション名を入力または選択
3. 取得レコード数を指定（1-500）
4. 「検索実行」ボタンをクリック

### 3. アプリ選択方法
- **現在のアプリを選択**: 現在表示中のアプリを自動選択
- **アプリ一覧を表示**: スペース内の全アプリを一覧表示して選択（画面自動リセット機能付き）
- **直接入力**: アプリ名を直接入力

### 4. CSV出力機能
- **スキーマCSV**: データベース構造をCSV形式でダウンロード
- **レコードCSV**: 取得したレコードデータをCSV形式でダウンロード
- ファイル名: `アプリ名_schema_YYYY-MM-DD.csv` / `アプリ名_records_YYYY-MM-DD.csv`

## 機能一覧

### 表示機能
- **スキーマ表示**: フィールド構造の詳細表示（オプション詳細カラム付き）
- **レコードデータ表示**: テーブル形式での見やすい表示
- **サブテーブル表示**: 各サブテーブルを独立したテーブルとして表示（subtableDisplay.js使用時）
- **カラムリサイズ**: 全テーブルでマウスドラッグによる幅調整
- **統一されたUI**: フィールドコードカラムのフォントとサイズをフィールド名カラムに統一

### 検索機能
- **アプリ名検索**: 部分一致でのアプリ検索
- **指定件数取得**: 1-500件の範囲でレコード取得
- **リアルタイム結果表示**: 即座に結果をテーブル表示

### エクスポート機能
- **スキーマCSV**: 完全なフィールド情報（グループ・サブテーブル展開）
- **レコードCSV**: 基本レコードデータ
- **サブテーブル含むCSV**: サブテーブルデータも完全出力
- **Excel対応**: BOM付きUTF-8エンコーディング

### UI機能
- **アプリ選択**: 現在のアプリ自動選択・一覧からの選択・直接入力
- **メッセージシステム**: 成功・エラー・情報メッセージの表示
- **エラーハンドリング**: 詳細なエラー情報とガイダンス
- **レスポンシブUI**: 様々な画面サイズに対応
- **画面リセット**: アプリ一覧表示時の自動画面クリア

### 高度な機能
- **グループフィールド対応**: グループ内フィールドの完全サポート
  - レイアウト情報からの詳細フィールド取得
  - `code`プロパティが存在しないフィールドの適切なキー生成
  - グループ内フィールド数の正確な表示
- **サブテーブル対応**: サブテーブルフィールドの完全サポート
- **計算フィールド対応**: 計算式の詳細表示
- **関連レコード一覧対応**: 関連アプリや条件設定の詳細表示
- **ルックアップフィールド完全対応**: フィールドタイプに関係なくlookupプロパティを持つフィールドを処理
  - 参照アプリ、参照キー、フィールドマッピング、検索対象、絞り込み、ソート情報の詳細表示
  - グループ内・サブテーブル内のルックアップフィールドも完全対応
- **LABELフィールド対応**: ラベルフィールドの適切な表示・処理
- **アプリ名表示機能**: 関連レコード一覧・ルックアップフィールドでのアプリ名自動表示
  - フォーマット: `アプリ名 (アプリID)` 形式で表示
  - 自動キャッシュ機能により効率的なアプリ名取得
  - アプリ名が取得できない場合は従来通り `AppID: アプリID` 形式で表示
  - CSV出力・UI表示両方に対応
- **オプション詳細**: 選択肢・設定値・フィールド数・計算式・参照情報の詳細表示
- **依存関係チェック**: モジュール読み込み状況の自動確認

## エラー対処

### 依存関係エラー
必須モジュールが読み込まれていない場合、アラートが表示されます。
指定された順序でファイルを読み込んでください。

### API エラー
- アプリが見つからない場合: アプリ名を確認してください
- 権限エラー: アプリへのアクセス権限を確認してください
- ネットワークエラー: 接続状況を確認してください

## 開発・拡張

### 新しいモジュールの追加
1. 新しい機能を独立したファイルとして作成
2. `window.ModuleName` として公開
3. queryTable-main.js の依存関係チェックに追加

### カスタマイズ
各モジュールは独立しているため、必要に応じて個別にカスタマイズできます。

## 変更履歴
- **v1.7.0**: ルックアップフィールド処理の完全対応とUI統一
  - フィールドタイプに関係なくlookupプロパティを持つフィールドをルックアップとして処理
  - フィールドコードカラムのフォントとサイズをフィールド名カラムに統一
  - グループ内・サブテーブル内のルックアップフィールドも完全対応
  - 全モジュール（UI表示、CSV出力、グループ処理、サブテーブル処理）での統一対応
- **v1.6.0**: グループフィールド処理の大幅改善
  - グループフィールド内のフィールドキー生成問題を解決
  - `code`プロパティが存在しないフィールドの適切なキー生成機能追加
  - レイアウト情報からの詳細フィールド取得処理の最適化
  - グループ内フィールド数の正確な表示
  - ログ出力の最適化（不要なログの削除）
  - UIリセット機能の追加（アプリ一覧表示時の画面クリア）
  - LABEL・LOOKUPフィールドの完全対応
- **v1.5.0**: アプリ名表示機能追加
  - 関連レコード一覧フィールド・ルックアップフィールドでアプリ名も併せて表示
  - フォーマット: `アプリ名 (アプリID)` 形式での表示
  - アプリ名キャッシュ機能による効率的なアプリ名取得
  - CSV出力・UI表示両方でアプリ名表示対応
  - queryTable-main.js でのアプリ名キャッシュ初期化処理追加
- **v1.4.0**: 高度なフィールドタイプ対応
  - 計算フィールドのオプション詳細対応（計算式表示）
  - 関連レコード一覧フィールドのオプション詳細対応（関連アプリ、条件、表示フィールド等）
  - ルックアップフィールドのオプション詳細対応（参照アプリ、フィールドマッピング等）
  - 全モジュールでの高度フィールドタイプ統一対応
- **v1.3.0**: UI機能大幅強化
  - オプション詳細カラム追加（CSVと同等の詳細情報表示）
  - テーブルカラムリサイズ機能（全テーブル対応）
  - グループ・サブテーブルフィールド数表示
  - ラベルフィールドサポート追加
  - サブテーブル表示のリサイズ対応
- **v1.2.0**: アーキテクチャ改善
  - グループフィールド処理の専用モジュール化（groupFieldProcessor.js）
  - サブテーブルフィールド処理の専用モジュール化（subtableFieldProcessor.js）
  - コード保守性向上・重複コード削除
- **v1.1.0**: 機能拡張
  - グループフィールド内スキーマ表示
  - CSV出力でのグループフィールド処理
  - サブテーブル処理の完全対応
- **v1.0.0**: 初期リリース（モジュール分割版）
  - 旧バージョンから機能を分割し、保守性を向上

## 注意事項
- **環境要件**: Kintone環境でのみ動作します
- **パフォーマンス**: 大量データの取得は時間がかかる場合があります（最大500件まで）
- **文字エンコーディング**: CSVファイルはUTF-8（BOM付き）でExcel対応
- **Excel CSV表示**: 計算式にカンマが含まれる場合、Excelで自動的にCSVを開くと列が正しく分割される場合があります。この場合は「データ」→「テキストファイル」から手動でインポートしてください
- **ブラウザ対応**: モダンブラウザ（Chrome、Firefox、Edge、Safari）推奨
- **権限**: アプリへの参照権限が必要です
- **ファイル読み込み順序**: 依存関係を守って正しい順序で読み込んでください

## パフォーマンス最適化
- **大きなテーブル**: カラムリサイズ機能により必要な情報に集中して表示
- **サブテーブルデータ**: 必要に応じてsubtableDisplay.jsを読み込み
- **CSV出力**: 大量データの場合は段階的に出力することを推奨
- **ログ出力**: デバッグ用ログは必要最小限に最適化済み

